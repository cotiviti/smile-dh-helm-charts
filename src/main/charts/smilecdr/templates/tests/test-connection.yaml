{{- range $theNodeName, $theNodeCtx := include "smilecdr.nodes" . | fromYaml -}}
  {{- $theNodeSpec := $theNodeCtx.Values -}}
  {{- /* Find the module that has the healthcheck. We will use this for the
      Helm test hook */ -}}
  {{- /* $modules := include "smilecdr.modules" $theNodeSpec | fromYaml */ -}}
  {{- $localURL := "" -}}
  {{- range $theServiceName, $theServiceSpec := $theNodeSpec.services -}}
    {{- if $theServiceSpec.enableReadinessProbe -}}
      {{- $localURL = printf "%s:%d" $theServiceSpec.resourceName (int $theServiceSpec.port) -}}
    {{- end -}}
  {{- end -}}
  {{- $podName := printf "%s-%s-test-connection" $.Release.Name ($theNodeSpec.nodeId | lower) -}}
  {{- /* The below are just overrides for compatibility mode and will be removed in the future. */ -}}
  {{- if $theNodeSpec.oldResourceNaming -}}
    {{- $localURL = printf "smilecdr-admin_web:%d" (int $theNodeSpec.services.admin_web.port) -}}
    {{- $podName = printf "%s-smilecdr-test-connection" $.Release.Name -}}
  {{- end -}}
apiVersion: v1
kind: Pod
metadata:
  name: {{ $podName | quote }}
  labels:
    {{- toYaml $theNodeSpec.cdrNodeLabels | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['{{ $localURL }}']
      resources:
        limits:
          cpu: 10m
          memory: 128Mi
        requests:
          cpu: 10m
          memory: 128Mi
  restartPolicy: Never
---
{{ end }}
